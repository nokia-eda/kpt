apiVersion: v1
data:
  entrypoint-embed.sh: "#!/bin/bash\n\n############################################################################\n#\n#              Copyright (c) 2023 Nokia\n#\n############################################################################\n\ntrap : TERM INT\n\nentrypoint_log() {\n\techo \"$(date): $*\"\n}\n\nentrypoint_log \"entrypoint.sh called\"\n\nentrypoint_log \"Add /.cxmode\"\n[[ -f /.cxmode ]] || touch /.cxmode\n\n# make dir for unix socket\n[[ -d \"/opt/srlinux/var/run\" ]] || mkdir -p /opt/srlinux/var/run\n\n# make dir for cxmgr log\n[[ -d \"/var/log/srlinux/debug/\" ]] || sudo mkdir -p /var/log/srlinux/debug/\n\n[[ -f /opt/srlinux/etc/profile.d/sr_app_env.sh ]] && source  /opt/srlinux/etc/profile.d/sr_app_env.sh\n\n# capability for third party apps\ntraceroute_path=$(readlink -f /usr/sbin/traceroute)\nip_path=$(readlink -f /usr/sbin/ip)\n\nsudo setcap cap_net_raw=eip \"$traceroute_path\"\nsudo setcap cap_sys_admin=eip \"$ip_path\"\n[[ -f /usr/bin/tcpdump ]] && sudo setcap cap_net_raw,cap_net_admin=eip /usr/bin/tcpdump\n\nentrypoint_log \"entrypoint.sh done, executing $*\"\nentrypoint_log \"Starting CxMgr\"\nlog_file=/var/log/srlinux/debug/cxmgr.log\npodips_file=/etc/config/configmap/podips\ntopology_file=/etc/config/configmap/topology\nlinks_file=/etc/config/configmap/links\n\nwhile [ ! -f \"$podips_file\" ]; do\n\techo \"Waiting for podips file to appear...\"\n    sleep 1\ndone\nwhile true; do\n    if grep -E \"^- name: $SRL_CHASSIS_NAME$\" \"$topology_file\" > /dev/null; then\n        echo \"$SRL_CHASSIS_NAME exists in the YAML file\"\n\t\tbreak\n    else\n        echo \"$SRL_CHASSIS_NAME does not exist in the topology file yet, sleeping\"\n        sleep 1\n    fi\ndone\n#$(LD_LIBRARY_PATH=/opt/srlinux/lib:/opt/srlinux/usr/lib /opt/srlinux/bin/cxmgr --log-level debug --log-stdout)\n$(/opt/srlinux/bin/cxmgr --log-stdout --log-level DEBUG > \"$log_file\" 2>&1 &)\n\ntail -f --retry \"$log_file\" & wait"
kind: ConfigMap
metadata:
  name: cx-cxdp-init
  namespace: eda-system # kpt-set: ${EDA_CORE_NAMESPACE}
